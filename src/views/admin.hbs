<div class="mt-5 container-fluid">

  <h1 class="text-center mb-5">User management</h1>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th></th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Faculties</th>
          <th>Close Date</th>
          
          <th class="text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {{#each data}}
        <tr>
          <th>
            <img src="/{{img}}" class="img-fluid rounded-circle" style="height: 40px; width: 40px" />
          </th>
          <th>{{name}}</th>
          <th>{{email}}</th>
          <th>
             The user wants the position to apply for: {{roleTreatment}}
            <select class="form-select" onchange="submitChangeRole(this, '{{_id}}')">
              {{#each ../nameRole}}
              <option value="{{_id}}" {{#ifEqual _id ../role._id}}selected{{/ifEqual}}>{{name}}</option>
              {{/each}}
            </select>
          </th>
          <th>
            The user wants to be in the faculty: {{facultyWant}}
            <select class="form-select" onchange="submitChangeFaculties(this, '{{_id}}')">
              <option value="" disabled selected>Choose one</option>
              {{#each ../dataFacultis}}
              <option value="{{_id}}" {{#ifEqual _id ../facultis._id}}selected{{/ifEqual}}>{{nameFaculty}}</option>
              {{/each}}
            </select>
          </th>
          <th>
                 CloseDate: {{formatDate this.closedate.closeDates}} <br> 
                 FinalDate: {{formatDate this.closedate.finalCloseDates}}
            <select class="form-select" onchange="submitChangeCloseDate(this, '{{_id}}')">
               <option value="" disabled selected>Choose one</option>
               {{#each ../dataClose}}
                <option value="{{_id}}"{{#ifEqual _id ../closedates._id}}selected{{/ifEqual}} >{{formatDate closeDates}} - {{formatDate finalCloseDates}} </option>
                {{/each}}
            </select>
            
          </th>
          <td>
            {{!-- <button class="btn btn-primary"><i class="fa fa-info-circle" aria-hidden="true"></i></button> --}}
            <button class="btn btn-primary"><i class="fa fa-pencil-square" aria-hidden="true"></i></button>
            {{!-- <button class="btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i></button> --}}
             <button type="submit" class="btn btn-primary mt-3" onclick="deleteUser('{{_id}}')" >Delete</button>
          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
<div>
</div><br>
<div class="row">
<div class="col-md-6">
<section class="container" class="row">
<div class="border p-4" style="width: 500px;" class="col-sm">
<h2 class="text-center">Academic Year</h2>
  <form action="/admin/academic" method="post">
   <div class="form-group mt-3">
    <label for="academic">Start Academic Year</label>
    <input type="date" name="academicStart" id="academicStart" value="" />
    </div>
    <div class="form-group mt-3">
    <label for="End academic">End Academic Year</label>
    <input type="date" name="academicEnd" id="academicEnd" value="" />
    </div>
    <button type="submit" class="btn btn-primary mt-3">submit</button>
  </form>
  <br>

<table class="table">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Start</th>
      <th scope="col">End</th>
      <th scope="col">Action</th>
    </tr>
  </thead>
  <tbody>
    {{#each dataAcademicyears}}
      <tr>
        
        <td>
          
          <input
            type="date"
           
            id="academicYears_{{this._id}}"
            name="academicYears"
            value="{{formatDate this.academicYears}}"
          />
          <p> {{formatDate  this.academicYears}}</p>
          </td>
        <td>
          
          <input
            type="date"
            id="End_{{this._id}}"
            name="End"
            value="{{formatDate this.End}}"
          />
          <p>{{formatDate this.End}}</p>
          <td><button onclick="upA('{{_id}}')" class="btn btn-primary">Edit</button>
          <br>
              <button onclick="deA('{{_id}}')" class="btn btn-primary">Delete</button>
          </td>
      </tr>
    {{/each}}
  </tbody>
</table>

</div>






</section>

<br>

</div>
<div class="col-md-6">
<section class="container" class="row">
<div class="border p-4" style="width: 500px;" class="col-sm">
<h2 class="text-center">Faculties</h2>
  <form action="/admin/facultyC" method="post">
   <div class="form-group mt-3">
    <label for="academic">Create a new Faculty </label> <br>
    <input type="text" name="nameFaculty" id="nameFaculty" value="" />
    </div>
    <button type="submit" class="btn btn-primary mt-3">submit</button>
  </form>
  <br>
  <table class="table">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Faculty</th>
      <th scope="col">Action</th>
    </tr>
  </thead>
  <tbody>
    {{#each dataFacultis}}
      <tr>
        
        <td>
          <input
            type="text"
            id="nameFaculty_{{this._id}}"
            name="nameFaculty"
            value="{{this.nameFaculty}}"
          />
          </td>
          <td>
            <button onclick="updateFa('{{_id}}')" class="btn btn-primary">Edit</button><br>
            <button onclick="deleteFa('{{_id}}')" class="btn btn-primary">Delete</button>
          </td>
      </tr>
    {{/each}}
  </tbody>
</table>
  
</div>
</section>

</div>

<br>

<section class="container">
  <div class="border p-4">
    <h3 class="text-center">CloseDate</h3>
    <form action="/admin/closeDate" method="post">
      <div class="form-group mt-3">
        <label for="closedate">Close Dates</label>
        <input type="date" class="form-control" name="closedate" id="closedate" />
      </div>
      <div class="form-group mt-3">
        <label for="finalclosedate">Final Close Date</label>
        <input type="date" class="form-control" name="finalclosedate" id="finalclosedate" />
      </div>
      <div class="form-group mt-3">
        <label for="academic">Academic Year</label>
        <select class="form-control" name="academic" id="academic" required>
          <option value="" selected disabled>Choose one</option>
          {{#each dataAcademicyears}}
          <option value="{{_id}}">{{formatDate academicYears}} - {{formatDate End}}</option>
          {{/each}}
        </select>
      </div>
      <div class="form-group mt-3">
        <label for="faculty">Facultis</label>
        <select class="form-control" name="faculty" id="faculty" required>
          <option value="" selected disabled>Choose one</option>
          {{#each dataFacultis}}
          <option value="{{_id}}">{{nameFaculty}}</option>
          {{/each}}
        </select>
      </div>
      <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>

       </form>
  <br>
  <table class="table">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Close Dates</th>
      <th scope="col">Final Close Date</th>
      <th scope="col">Academic Year</th>
      <th scope="col">Facultis</th>
      <th scope="col">Action</th>
    </tr>
  </thead>
  {{#each dataClose}}
  <tbody>
 
      <tr>
        
        <td> 
              <p>Start: {{formatDate closeDates}}</p>
               <input type="date" class="form-control" name="closedate" id="closedate_{{this._id}}" value="{{formatDate this.closedate}}" />
             
          </td>
               <td>
                <p>End: {{formatDate finalCloseDates}}</p>
                <input type="date" class="form-control" name="finalclosedate" id="finalclosedate_{{this._id}}" value="{{formatDate this.finalCloseDates}}" />
              </td>
           <td>
         
           <p>{{formatDate academic.academicYears}} - {{formatDate academic.End}}</p>
          <select class="form-select" onchange="subAca(this, '{{_id}}')"required>
             <option value="" selected disabled>Choose one </option>
               {{#each ../dataAcademicyears}} 
                   <option value="{{_id}}"{{#ifEqual _id ../dataAcademicyears._id}}selected{{/ifEqual}} >{{formatDate academicYears}} - {{formatDate End}} </option>
               {{/each}}
        </select>
          
           </td>   
           <td>

          <select class="form-select" onchange="subFa(this, '{{_id}}')"required>
             <option value="" selected disabled>Choose one </option>
               {{#each ../dataFacultis}} 
                   <option value="{{_id}}"{{#ifEqual _id ../dataFacultis._id}}selected{{/ifEqual}} >{{nameFaculty}} </option>
               {{/each}}
        </select>
           </td>
           
           <td><button onclick="closedateUp('{{_id}}')" class="btn btn-primary">Edit</button>
                <button onclick="deleteClose('{{_id}}')" class="btn btn-primary">Delete</button>
           </td>
      </tr>
  
  </tbody>
  {{/each}}
</table>
  </div>
</section>

<br>
<br>
<section class="container">
  <h4 class="text-center">Articles</h4>
<table class="table">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Name Student</th>
      <th scope="col">Name Articles</th>
      <th scope="col">Description</th>
      <th scope="col">Image</th>
      <th scope="col">Document</th>
      <th scope="col">CreatedAt</th>
      <th scope="col">Comment</th>
      <th scope="col">Action</th>
    </tr>
  </thead>
  <tbody>
    {{#each dataAr}}
      <tr>
        <td>{{this.users.name}} </td>
        <td>{{this.articlesName}}</td>
        <td>{{this.description}}</td>
        <td><img src="{{this.img}}" alt="..." height="130" width="150" /></td>
        <td> <a href="{{this.doc}}" download="document"> Document</a></td>
        <td>{{formatDate this.createdAt}}</td>
        <td>{{this.comment}}</td>
        <td>
          <button onclick="deleteAr('{{_id}}')"  class="btn btn-primary">
            Delete
          </button>
        </td>
      </tr>
    {{/each}}
  </tbody>
</table>
</section>



<h3>Statistics</h3>
<table class="table table-dark">
  <thead>
    <tr>

      <th scope="col">Name Faculty</th>
      <th scope="col">Sum Articles </th>
      <th>Sum Users : {{tong}}</th>
      <th>The general account did not submit the article: {{Ar.con}}</th>
    </tr>
  </thead>
  <tbody>

    <tr>
      {{#each sumAr}}
      <td>{{name}}</td>
      <td>{{count}}</td>
      {{/each}}
    </tr>

  </tbody>
</table>

<script>
  // Change role
  function submitChangeRole(e, id) {
    const selectRoleId = e.value;
    const userId = id;

    axios.put(`/admin/update/${userId}`, { role: selectRoleId })
      .then((res) => {
        e.style.background = "#84dd89"
      })
      .catch((err) => {
        e.style.background = "rgb(255,86,86)"
      })
      .finally(() => {
        setTimeout(function () {
          e.style.background = "";
        }, 2000);
      })
  }

  // Change faculty
  function submitChangeFaculties(e, id) {
    const selectFacultyId = e.value;
    const userId = id;

    console.log('selectFacultyId: ', selectFacultyId);

    axios.put(`/admin/update/${userId}`, { facultis: selectFacultyId })
      .then((res) => {
        e.style.background = "#84dd89"
      })
      .catch((err) => {
        e.style.background = "rgb(255,86,86)"
      })
      .finally(() => {
        setTimeout(function () {
          e.style.background = "";
        }, 2000);
      })
  }

 // ChangeCloseDate

 function submitChangeCloseDate(e, id) {
  const selectCloseDateId = e.value;
  const userId = id;

  console.log('selectCloseDate: ', selectCloseDateId)

  axios.put(`/admin/update/${userId}`, {closedate: selectCloseDateId})
  .then((res) => {
     e.style.background = "#84dd89"
  }).catch((err)=>{
    e.style.background = "rgb(255,86,86)"
  }).finally(() => {
        setTimeout(function () {
          e.style.background = "";
        }, 2000);
      })


 }




function upA(id) {
  var academicYearsInput = document.getElementById("academicYears_" + id);
  var academicYears = academicYearsInput ? academicYearsInput.value : "";
  var EndInput = document.getElementById("End_" + id);
  var End = EndInput ? EndInput.value : "";
 

  axios
    .put(`/admin/updateA/${id}`, { academicYears, End })
    .then((data) => {
      console.log(data);
      return window.location.reload();
    })
    .catch((error) => {
      return alert("failed");
    });
}




function deA(id) {
  axios
    .delete(`/admin/deleteAcademic/${id}`)
    .then((result) => {
      window.location.reload();
    })
    .catch((error) => {
      alert("that bai");
    });
}




function updateFa(id) {
  var nameFacultyInput = document.getElementById("nameFaculty_" + id);
  var nameFaculty= nameFacultyInput ? nameFacultyInput.value : "";
  axios
    .put(`/admin/updateFa/${id}`, { nameFaculty })
    .then((data) => {
      console.log(data);
      return window.location.reload();
    })
    .catch((error) => {
      return alert("failed");
    });
}


function deleteFa(id) {
  axios
    .delete(`/admin/deleteFa/${id}`)
    .then((result) => {
      window.location.reload();
    })
    .catch((error) => {
      alert("that bai");
    });
}



function subAca(e,id) {
    const selectAcaId = e.value;
    console.log(selectAcaId);
  axios
    .put(`/admin/closedateUp/${id}`, { academic: selectAcaId })
    .then((data) => {
      console.log(data);
      return window.location.reload();
    })
    .catch((error) => {
      return alert("failed");
    });
}

function subFa(e,id) {
    const selectFaId = e.value;
  axios
    .put(`/admin/closedateUp/${id}`, { faculty:selectFaId })
    .then((data) => {
      console.log(data);
      return window.location.reload();
    })
    .catch((error) => {
      return alert("failed");
    });
}






function closedateUp(id) {
  var closedateInput = document.getElementById("closedate_" + id);
  var closedate = closedateInput ? closedateInput.value : "";
  var finalCloseDatesInput = document.getElementById("finalCloseDates_" + id);
  var finalCloseDates = finalCloseDatesInput ? finalCloseDatesInput.value : "";
 

  axios
    .put(`/admin/closedateUp/${id}`, {finalCloseDates , closedate})
    .then((data) => {
      console.log(data);
      return window.location.reload();
    })
    .catch((error) => {
      return alert("failed");
    });
}



function deleteClose(id) {
  axios
    .delete(`/admin/deleteCloseDates/${id}`)
    .then((result) => {
      window.location.reload();
    })
    .catch((error) => {
      alert("that bai");
    });
}


function deleteAr(id) {
  axios
    .delete(`/admin/deleteAr/${id}`)
    .then((result) => {
      window.location.reload();
    })
    .catch((error) => {
      alert("that bai");
    });
}
</script>

